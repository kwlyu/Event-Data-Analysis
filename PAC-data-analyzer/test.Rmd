```{r reading google sheet}
# Install googlesheets4 if not already installed
# install.packages("googlesheets4")

# Load necessary libraries
library(googlesheets4)
library(dplyr)
library(purrr)
library(janitor)

# Define the Google Sheet URL
sheet_url <- "https://docs.google.com/spreadsheets/d/1a0wHpBMmUMoeKrTK23nHcYvFpQ2djmcYKmjJqEJWX1I/edit#gid=265403245"

# Get the list of sheet names from the Google Sheet
sheet_names_list <- sheet_names(sheet_url)

# Create a function to read and clean a sheet
read_and_clean_event_file <- function(sheet_name) {
  # Read the sheet using googlesheets4
  data <- read_sheet(sheet_url, sheet = sheet_name)
  
  # Clean column names and ensure all columns are character type
  clean_names(data) %>%
    mutate(across(everything(), as.character)) %>%
    mutate(term = str_sub(sheet_name, 1, 3)) # Extract the term from the sheet name
}

# Use purrr to read all sheets and store them in a named list
event_data_list <- set_names(map(sheet_names_list, read_and_clean_event_file), sheet_names_list)

# Combine all the data frames into one
combined_data <- reduce(event_data_list, full_join)

combined_data_filtered <- combined_data %>%
  filter(!is.na(what), what != "") %>% 
  filter(what != "Choir & Jazz Rehearsal") %>% 
  filter(what != "Jazz Rehearsal") %>% 
  mutate(date = as.Date(ymd(date))) %>% 
  mutate(support_level = if_else(support_level == "N" | support_level == "Y", "L", support_level)) %>% 
  mutate(
    department = str_replace_all(department, "WCC", "ODOA"),
    department = str_replace_all(department, "MSUC", "MUSC"),
    department = str_replace_all(department, "French Dept|French", "FREN"),
    department = str_replace_all(department, "English", "ENGL"),
    department = str_replace_all(department, "Pres. Office", "PRES"),
    department = str_replace_all(department, "History", "HIST"),
    department = str_replace_all(department, "THD", "THDA"),
    department = str_replace_all(department, "Inclusion & Equity", "IEC"),
    venue = str_replace_all(venue, "Skinner Chapel", "Chapel"),
    department = str_replace_all(department, "/", " & "),
    department = str_replace_all(department, ",", " &"),
    venue = str_replace_all(venue, ",", " &"),
    department = str_replace_all(department, "\\s+", " ")  # Remove extra spaces
  ) %>% 
  select(-wk) %>% 
  mutate(department_type = case_when(
      department == "MUSC" ~ "MUSC",
      department == "ODOA" ~ "ODOA",
      department == "CSA" ~ "CSA",
      str_detect(department, "&") ~ "Collab",
      TRUE ~ "Others"
    )) %>% 
  mutate(what = str_replace_all(what, "Jazz Ensemble Concert|Jazz Area Concert", "Jazz Concert"),
         what = str_replace_all(what, "Symphony Band Concert", "Symphony Concert"),
         what = str_replace_all(what, "Composition Recital", "Composition Showcase Recital"),
         what = str_replace_all(what, "Harpichord", "Harpsichord"),
         what = str_replace_all(what, "Emsemble", "Ensemble"),
         what = str_replace_all(what, "Juest Cellin'", "Just Cellin'"),
         what = str_replace_all(what, "Facutly|FACULTY|Mazariello", "Faculty")) %>% 
  mutate(event_type = case_when(
    str_detect(what, "GUEST|ODOA|Concert Series|SPCO") ~ "Guest",
    str_detect(what, "Faculty") ~ "Faculty Recital",
    str_detect(what, "Student|Senior|Junior|Piano Recital: |Johnson|Verma Jameson") ~ "Student Recital",
    str_detect(what, "Studio Recital|Organ & Harpsichord|Composition Showcase Recital|Chamber Recital|Chamber Music Recital|Chamber Music|Organ Recital|Strings Recital|Violin & Viola|Violin/Viola|Drum Ensemble|Drum Recital|Voice Showcase Recital|Chinese Music Recital|Piano Studios Recital|Jazz Chamber|Piano Recital|Comps Fest|Recorder Recital|Music Ensemble|Studio") ~ "Studio Recital",
    str_detect(what, "Orchestra Concert|Jazz Concert|Symphony Concert|Symphony Band|Choir Concert|Orchestra and Choir|Chinese & Global|Chinese Global Concert|Chinese and Global|Chinese Music Concert|Chinese Music Ensemble|Chinese Ensemble|Music Comps|Jazz Vocal Concert") ~ "Ensemble Concert",
    str_detect(what, "CSA|Just Cellin|Lunar New Year|ACA|A Cappella|Accidentals|Exit 69|Date Knight|Knights|Knightingales|International Festival") ~ "Student Activity",
    str_detect(what, "Masterclass|Lecture|Symposium") ~ "Masterclass",
    str_detect(what, "Trustees|Trustee's|Presidents|Conference|President's|Presentation") ~ "Presentation",
    str_detect(what, "Clinic|Music Fest|Music Department Showcase|Melinda Russell|Launch|Event|Opening") ~ "Special Events",
      TRUE ~ "Guest"
  )) %>% 
  mutate(year = term_to_year(term)) %>% 
  mutate(term = factor(term, levels = c("F14", "W15", "S15",
                                        "F15", "W16", "S16", "F16", "W17", "S17", 
                                        "F17", "W18", "S18", "F18", "W19", "S19", 
                                        "F19", "W20", "S20", "F20", "W21", "S21", 
                                        "F21", "W22", "S22", "F22", "W23", "S23", 
                                        "F23", "W24", "S24"), ordered = TRUE)) %>%
  arrange(year, term) %>%
  mutate(
    term_category = case_when(
      str_detect(term, "^F") ~ "Fall",
      str_detect(term, "^W") ~ "Winter",
      str_detect(term, "^S") ~ "Spring"
    )
  ) %>%
  mutate(term_category = factor(term_category, levels = c("Spring", "Winter", "Fall"), ordered = TRUE))

# Example mapping of term to start dates
term_start_dates <- data.frame(
  term = c("F14", "W15", "S15", 
           "F15", "W16", "S16", 
           "F16", "W17", "S17", 
           "F17", "W18", "S18", 
           "F18", "W19", "S19", 
           "F19", "W20", "S20", 
           "F20", "W21", "S21", 
           "F21", "W22", "S22", 
           "F22", "W23", "S23", 
           "F23", "W24", "S24"),  # Add all relevant terms
  start_date = as.Date(c("2014-09-15", "2015-01-05", "2015-03-30",
                         "2015-09-14", "2016-01-04", "2016-03-28",
                         "2016-09-12", "2017-01-04", "2017-03-27",
                         "2017-09-11", "2018-01-03", "2018-03-26",
                         "2018-09-10", "2019-01-07", "2019-04-01",
                         "2019-09-16", "2020-01-06", "2020-03-30",
                         "2020-09-14", "2021-01-04", "2021-03-29",
                         "2021-09-15", "2022-01-05", "2022-03-28",
                         "2022-09-12", "2023-01-04", "2023-03-27",
                         "2023-09-11", "2024-01-03", "2024-03-25"))  # Adjust start dates accordingly
)

# Join the start dates to the main data and calculate week_of_term
combined_data_filtered <- combined_data_filtered %>%
  left_join(term_start_dates, by = c("term" = "term")) %>%
  mutate(
    # Calculate the week of the term based on Monday as the first day of the week
    week_of_term = as.integer((floor_date(date, unit = "week", week_start = 1) - 
                               floor_date(start_date, unit = "week", week_start = 1)) / 7) + 1
  )

# Reorder columns to make week_of_term the third column
combined_data_filtered <- combined_data_filtered %>%
  select(venue, date, week_of_term, everything()) %>%
  select(-start_date)

event_summary <- combined_data_filtered %>% 
  group_by(year, term) %>% 
  summarize(term_total = n(), .groups = 'drop') %>%
  group_by(year) %>% 
  mutate(year_total = sum(term_total)) %>% 
  ungroup()
```

```{r functionalized term names}
# Install googlesheets4 if not already installed
# install.packages("googlesheets4")

# Load necessary libraries
library(googlesheets4)
library(dplyr)
library(purrr)
library(janitor)
library(stringr)
library(lubridate)

# Define the Google Sheet URL
sheet_url <- "https://docs.google.com/spreadsheets/d/1a0wHpBMmUMoeKrTK23nHcYvFpQ2djmcYKmjJqEJWX1I/edit#gid=265403245"

# Get the list of sheet names from the Google Sheet
sheet_names_list <- sheet_names(sheet_url)

# Extract the terms from the sheet names dynamically
extracted_terms <- sheet_names_list %>%
  str_extract("^[A-Z]\\d{2}") %>%
  na.omit()  # Remove any NA values in case some sheet names do not follow the pattern

# Ensure unique and sorted terms
unique_terms <- sort(unique(extracted_terms))

# Create a function to read and clean a sheet
read_and_clean_event_file <- function(sheet_name) {
  # Read the sheet using googlesheets4
  data <- read_sheet(sheet_url, sheet = sheet_name)
  
  # Clean column names and ensure all columns are character type
  clean_names(data) %>%
    mutate(across(everything(), as.character)) %>%
    mutate(term = str_sub(sheet_name, 1, 3)) # Extract the term from the sheet name
}

# Use purrr to read all sheets and store them in a named list
event_data_list <- set_names(map(sheet_names_list, read_and_clean_event_file), sheet_names_list)

# Combine all the data frames into one
combined_data <- reduce(event_data_list, full_join)

# Define the term start dates (hardcoded as per the original logic)
term_start_dates <- data.frame(
  term = c("F14", "W15", "S15", 
           "F15", "W16", "S16", 
           "F16", "W17", "S17", 
           "F17", "W18", "S18", 
           "F18", "W19", "S19", 
           "F19", "W20", "S20", 
           "F20", "W21", "S21", 
           "F21", "W22", "S22", 
           "F22", "W23", "S23", 
           "F23", "W24", "S24"),  # Add all relevant terms
  start_date = as.Date(c("2014-09-15", "2015-01-05", "2015-03-30",
                         "2015-09-14", "2016-01-04", "2016-03-28",
                         "2016-09-12", "2017-01-04", "2017-03-27",
                         "2017-09-11", "2018-01-03", "2018-03-26",
                         "2018-09-10", "2019-01-07", "2019-04-01",
                         "2019-09-16", "2020-01-06", "2020-03-30",
                         "2020-09-14", "2021-01-04", "2021-03-29",
                         "2021-09-15", "2022-01-05", "2022-03-28",
                         "2022-09-12", "2023-01-04", "2023-03-27",
                         "2023-09-11", "2024-01-03", "2024-03-25"))  # Adjust start dates accordingly
)

# Function to calculate the week of term
calculate_week_of_term <- function(event_date, term) {
  start_date <- term_start_dates %>%
    filter(term == !!term) %>%
    pull(start_date)
  
  if(length(start_date) == 0) return(NA_integer_)  # Return NA if no start_date is found
  
  # Calculate the week of the term based on Monday as the first day of the week
  week_of_term <- as.integer((floor_date(event_date, unit = "week", week_start = 1) - 
                              floor_date(start_date, unit = "week", week_start = 1)) / 7) + 1
  return(week_of_term)
}

# Apply the new function to calculate week_of_term dynamically
combined_data_filtered <- combined_data %>%
  filter(!is.na(what), what != "") %>%
  filter(what != "Choir & Jazz Rehearsal") %>%
  filter(what != "Jazz Rehearsal") %>%
  mutate(date = as.Date(ymd(date))) %>%
  mutate(support_level = if_else(support_level == "N" | support_level == "Y", "L", support_level)) %>%
  mutate(
    department = str_replace_all(department, "WCC", "ODOA"),
    department = str_replace_all(department, "MSUC", "MUSC"),
    department = str_replace_all(department, "French Dept|French", "FREN"),
    department = str_replace_all(department, "English", "ENGL"),
    department = str_replace_all(department, "Pres. Office", "PRES"),
    department = str_replace_all(department, "History", "HIST"),
    department = str_replace_all(department, "THD", "THDA"),
    department = str_replace_all(department, "Inclusion & Equity", "IEC"),
    venue = str_replace_all(venue, "Skinner Chapel", "Chapel"),
    department = str_replace_all(department, "/", " & "),
    department = str_replace_all(department, ",", " &"),
    venue = str_replace_all(venue, ",", " &"),
    department = str_replace_all(department, "\\s+", " ")  # Remove extra spaces
  ) %>%
  select(-wk) %>%
  mutate(department_type = case_when(
    department == "MUSC" ~ "MUSC",
    department == "ODOA" ~ "ODOA",
    department == "CSA" ~ "CSA",
    str_detect(department, "&") ~ "Collab",
    TRUE ~ "Others"
  )) %>%
  mutate(what = str_replace_all(what, "Jazz Ensemble Concert|Jazz Area Concert", "Jazz Concert"),
         what = str_replace_all(what, "Symphony Band Concert", "Symphony Concert"),
         what = str_replace_all(what, "Composition Recital", "Composition Showcase Recital"),
         what = str_replace_all(what, "Harpichord", "Harpsichord"),
         what = str_replace_all(what, "Emsemble", "Ensemble"),
         what = str_replace_all(what, "Juest Cellin'", "Just Cellin'"),
         what = str_replace_all(what, "Facutly|FACULTY|Mazariello", "Faculty")) %>%
  mutate(event_type = case_when(
    str_detect(what, "GUEST|ODOA|Concert Series|SPCO") ~ "Guest",
    str_detect(what, "Faculty") ~ "Faculty Recital",
    str_detect(what, "Student|Senior|Junior|Piano Recital: |Johnson|Verma Jameson") ~ "Student Recital",
    str_detect(what, "Studio Recital|Organ & Harpsichord|Composition Showcase Recital|Chamber Recital|Chamber Music Recital|Chamber Music|Organ Recital|Strings Recital|Violin & Viola|Violin/Viola|Drum Ensemble|Drum Recital|Voice Showcase Recital|Chinese Music Recital|Piano Studios Recital|Jazz Chamber|Piano Recital|Comps Fest|Recorder Recital|Music Ensemble|Studio") ~ "Studio Recital",
    str_detect(what, "Orchestra Concert|Jazz Concert|Symphony Concert|Symphony Band|Choir Concert|Orchestra and Choir|Chinese & Global|Chinese Global Concert|Chinese and Global|Chinese Music Concert|Chinese Music Ensemble|Chinese Ensemble|Music Comps|Jazz Vocal Concert") ~ "Ensemble Concert",
    str_detect(what, "CSA|Just Cellin|Lunar New Year|ACA|A Cappella|Accidentals|Exit 69|Date Knight|Knights|Knightingales|International Festival") ~ "Student Activity",
    str_detect(what, "Masterclass|Lecture|Symposium") ~ "Masterclass",
    str_detect(what, "Trustees|Trustee's|Presidents|Conference|President's|Presentation") ~ "Presentation",
    str_detect(what, "Clinic|Music Fest|Music Department Showcase|Melinda Russell|Launch|Event|Opening") ~ "Special Events",
    TRUE ~ "Guest"
  )) %>%
  mutate(year = term_to_year(term)) %>%
  mutate(term = factor(term, levels = unique_terms, ordered = TRUE)) %>%
  arrange(year, term) %>%
  mutate(
    term_category = case_when(
      str_detect(term, "^F") ~ "Fall",
      str_detect(term, "^W") ~ "Winter",
      str_detect(term, "^S") ~ "Spring"
    )
  ) %>%
  mutate(term_category = factor(term_category, levels = c("Spring", "Winter", "Fall"), ordered = TRUE)) %>%
  # Apply week_of_term calculation
  rowwise() %>%
  mutate(week_of_term = calculate_week_of_term(date, term)) %>%
  ungroup()

# Example event summary after filtering and transformation
event_summary <- combined_data_filtered %>%
  group_by(year, term) %>%
  summarize(term_total = n(), .groups = 'drop') %>%
  group_by(year) %>%
  mutate(year_total = sum(term_total)) %>%
  ungroup()

# View event_summary for validation
print(event_summary)

```

```{r plot 1}
library(googlesheets4)
library(dplyr)
library(stringr)
library(ggplot2)
library(plotly)

# Function to get sheet names from Google Sheets
get_sheet_names <- function(sheet_url) {
  sheet_names <- sheets_sheets(sheet_url)
  return(sheet_names)
}

# Function to extract term from sheet name
extract_term <- function(sheet_name) {
  # Extract term from sheet name assuming format "F14 - Event Data", "W15 - Event Data", etc.
  term_match <- str_extract(sheet_name, "^[FWS]\\d{2}")
  return(term_match)
}

# Function to process and sort event summary based on dynamic term levels
process_event_summary <- function(event_summary, sheet_names) {
  # Extract terms from sheet names
  terms <- unique(sapply(sheet_names, extract_term))
  
  # Define term levels based on sheet names
  term_levels <- c()
  for (season in c("F", "W", "S")) {
    term_levels <- c(term_levels, sort(terms[str_detect(terms, paste0("^", season))]))
  }
  
  event_summary %>%
    mutate(term = factor(term, levels = term_levels, ordered = TRUE)) %>%
    arrange(year, term) %>%
    mutate(
      term_category = case_when(
        str_detect(term, "^F") ~ "Fall",
        str_detect(term, "^W") ~ "Winter",
        str_detect(term, "^S") ~ "Spring"
      )
    ) %>%
    mutate(term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE))
}

# URL of the Google Sheets
sheet_url <- "https://docs.google.com/spreadsheets/d/1a0wHpBMmUMoeKrTK23nHcYvFpQ2djmcYKmjJqEJWX1I/edit?gid=265403245"

# Fetch sheet names
sheet_names <- sheet_names(sheet_url)

# Assuming event_summary is already loaded
# Process the event summary data frame
event_summary_processed <- process_event_summary(event_summary, sheet_names)

# Create the stacked bar chart using ggplot2
ggplot_event_summary <- ggplot(event_summary_processed, aes(x = year, y = term_total, fill = term_category)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = term_total), 
            position = position_stack(vjust = 0.5), 
            size = 3, 
            color = "black") +
  scale_fill_manual(values = c("Fall" = "#FF9999", "Winter" = "#99CCFF", "Spring" = "#99FF99")) +
  labs(x = "Year", y = "Total Events", fill = "Term") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert the ggplot object to a plotly object for interactivity
plotly_event_summary <- ggplotly(ggplot_event_summary)

# Display the plotly chart
plotly_event_summary

```



```{r plot 2}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)

# Function to summarize and pivot data for each year
summarize_and_pivot <- function(current_year) {
  combined_data_filtered %>%
    filter(year == current_year) %>%
    group_by(term_category, support_level) %>%
    summarize(Support = n(), .groups = 'drop') %>%
    pivot_wider(names_from = support_level, values_from = Support, values_fill = list(Support = 0)) %>%
    mutate(year = current_year)  # Add a year column to identify the table
}

# List of years to iterate over
years <- unique(combined_data_filtered$year)

# Use purrr::map to apply summarize_and_pivot function for each year
support_tables <- map_dfr(years, summarize_and_pivot)  # Combine into a single data frame

# Melt the data for ggplot
support_tables_melted <- support_tables %>%
  pivot_longer(cols = -c(term_category, year), names_to = "support_level", values_to = "Support")

# Ensure the term_category and support_level are factors with the correct order
support_tables_melted <- support_tables_melted %>%
  filter(support_level != "NA") %>% 
  mutate(term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE),
         support_level = factor(support_level, levels = c("NA", "H", "M", "L"), ordered = TRUE))

# Calculate percentages for each segment
support_tables_melted <- support_tables_melted %>%
  group_by(year, term_category) %>%
  mutate(total_support = sum(Support),
         percentage = (Support / total_support) * 100)

# Create the ggplot chart
ggplot_support_summary <- ggplot(support_tables_melted, aes(x = term_category, y = Support, fill = support_level)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(Support, " (", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5), size = 2, color = "black") +
  facet_wrap(~ year) +
  labs(x = "Term", y = "Support Count", fill = "Support Level") +
  scale_fill_manual(values = c("H" = "#FF9999", "M" = "#99CCFF", "L" = "#99FF99", "NA" = "black")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to a plotly object
plotly_support_summary <- ggplotly(ggplot_support_summary)

# Display the plotly chart
plotly_support_summary

```

```{r plot 3}

library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)

# Function to summarize and pivot data for each year
summarize_and_pivot_department <- function(current_year) {
  combined_data_filtered %>%
    filter(year == current_year) %>%
    group_by(term_category, department_type) %>%
    summarize(DepartmentCount = n(), .groups = 'drop') %>%
    pivot_wider(names_from = department_type, values_from = DepartmentCount, values_fill = list(DepartmentCount = 0)) %>%
    mutate(year = current_year)  # Add a year column to identify the table
}

# List of years to iterate over
years <- unique(combined_data_filtered$year)

# Use purrr::map to apply summarize_and_pivot function for each year
department_tables <- map_dfr(years, summarize_and_pivot_department)  # Combine into a single data frame

# Melt the data for ggplot
department_tables_melted <- department_tables %>%
  pivot_longer(cols = -c(term_category, year), names_to = "department_type", values_to = "DepartmentCount")

# Ensure the term_category and department_type are factors with the correct order
department_tables_melted <- department_tables_melted %>%
  mutate(term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE),
         department_type = factor(department_type, levels = c("MUSC", "ODOA", "CSA", "Collab", "Others"), ordered = TRUE))

# Filter out NA department types (if any)
department_tables_melted <- department_tables_melted %>%
  filter(department_type != "NA")

# Calculate percentages for each segment
department_tables_melted <- department_tables_melted %>%
  group_by(year, term_category) %>%
  mutate(total_count = sum(DepartmentCount, na.rm = TRUE),
         percentage = (DepartmentCount / total_count) * 100)

# Create the ggplot chart
ggplot_department_summary <- ggplot(department_tables_melted, aes(x = term_category, y = DepartmentCount, fill = department_type)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(DepartmentCount, " (", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5), size = 2, color = "black",
            check_overlap = TRUE) +
  facet_wrap(~ year) +
  labs(x = "Term", y = "Department Count", fill = "Department Type") +
  scale_fill_manual(values = c("MUSC" = "#FF9999", "ODOA" = "#99CCFF", "CSA" = "#99FF99", "Collab" = "#FFD700", "Others" = "#FFA500")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to a plotly object
plotly_department_summary <- ggplotly(ggplot_department_summary)

# Display the plotly chart
plotly_department_summary


```


```{r plot 4}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)

# Function to summarize and pivot data for each year
summarize_and_pivot_event <- function(current_year) {
  combined_data_filtered %>%
    filter(year == current_year) %>%
    group_by(term_category, event_type) %>%
    summarize(EventCount = n(), .groups = 'drop') %>%
    pivot_wider(names_from = event_type, values_from = EventCount, values_fill = list(EventCount = 0)) %>%
    mutate(year = current_year)  # Add a year column to identify the table
}

# List of years to iterate over
years <- unique(combined_data_filtered$year)

# Use purrr::map to apply summarize_and_pivot function for each year
event_tables <- map_dfr(years, summarize_and_pivot_event)  # Combine into a single data frame

# Melt the data for ggplot
event_tables_melted <- event_tables %>%
  pivot_longer(cols = -c(term_category, year), names_to = "event_type", values_to = "EventCount")

# Ensure term_category and event_type are characters before converting to factors
event_tables_melted <- event_tables_melted %>%
  mutate(
    term_category = as.character(term_category),
    event_type = as.character(event_type)
  )

# Apply the factor conversion with ordering
event_tables_melted <- event_tables_melted %>%
  mutate(
    term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE),
    event_type = factor(event_type, levels = c("Ensemble Concert", "Student Activity", "Studio Recital",
                                               "Guest", "Faculty Recital", "Student Recital",
                                               "Special Events", "Presentation", "Masterclass"),
                        ordered = TRUE)
  )

# Calculate percentages for each segment
event_tables_melted <- event_tables_melted %>%
  group_by(year, term_category) %>%
  mutate(total_count = sum(EventCount, na.rm = TRUE),
         percentage = (EventCount / total_count) * 100)

# Create the ggplot chart
ggplot_event_summary <- ggplot(event_tables_melted, aes(x = term_category, y = EventCount, fill = event_type)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(EventCount, " (", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5), size = 2, color = "black",
            check_overlap = TRUE) +
  facet_wrap(~ year) +
  labs(x = "Term", y = "Event Count", fill = "Event Type") +
  scale_fill_brewer(palette = "Set2") +  # Using a Brewer palette for default colors
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to a plotly object
plotly_event_summary <- ggplotly(ggplot_event_summary)

# Display the plotly chart
plotly_event_summary

```


