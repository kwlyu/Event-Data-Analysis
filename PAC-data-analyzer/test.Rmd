```{r reading google sheet}
# Install googlesheets4 if not already installed
# install.packages("googlesheets4")

# Load necessary libraries
library(googlesheets4)
library(dplyr)
library(purrr)
library(janitor)

# Define the Google Sheet URL
sheet_url <- "https://docs.google.com/spreadsheets/d/1a0wHpBMmUMoeKrTK23nHcYvFpQ2djmcYKmjJqEJWX1I/edit#gid=265403245"

# Get the list of sheet names from the Google Sheet
sheet_names_list <- sheet_names(sheet_url)

# Create a function to read and clean a sheet
read_and_clean_event_file <- function(sheet_name) {
  # Read the sheet using googlesheets4
  data <- read_sheet(sheet_url, sheet = sheet_name)
  
  # Clean column names and ensure all columns are character type
  clean_names(data) %>%
    mutate(across(everything(), as.character)) %>%
    mutate(term = str_sub(sheet_name, 1, 3)) # Extract the term from the sheet name
}

# Use purrr to read all sheets and store them in a named list
event_data_list <- set_names(map(sheet_names_list, read_and_clean_event_file), sheet_names_list)

# Combine all the data frames into one
combined_data <- reduce(event_data_list, full_join)

combined_data_filtered <- combined_data %>%
  filter(!is.na(what), what != "") %>% 
  filter(what != "Choir & Jazz Rehearsal") %>% 
  filter(what != "Jazz Rehearsal") %>% 
  mutate(date = as.Date(ymd(date))) %>% 
  mutate(support_level = if_else(support_level == "N" | support_level == "Y", "L", support_level)) %>% 
  mutate(
    department = str_replace_all(department, "WCC", "ODOA"),
    department = str_replace_all(department, "MSUC", "MUSC"),
    department = str_replace_all(department, "French Dept|French", "FREN"),
    department = str_replace_all(department, "English", "ENGL"),
    department = str_replace_all(department, "Pres. Office", "PRES"),
    department = str_replace_all(department, "History", "HIST"),
    department = str_replace_all(department, "THD", "THDA"),
    department = str_replace_all(department, "Inclusion & Equity", "IEC"),
    venue = str_replace_all(venue, "Skinner Chapel", "Chapel"),
    department = str_replace_all(department, "/", " & "),
    department = str_replace_all(department, ",", " &"),
    venue = str_replace_all(venue, ",", " &"),
    department = str_replace_all(department, "\\s+", " ")  # Remove extra spaces
  ) %>% 
  select(-wk) %>% 
  mutate(department_type = case_when(
      department == "MUSC" ~ "MUSC",
      department == "ODOA" ~ "ODOA",
      department == "CSA" ~ "CSA",
      str_detect(department, "&") ~ "Collab",
      TRUE ~ "Others"
    )) %>% 
  mutate(what = str_replace_all(what, "Jazz Ensemble Concert|Jazz Area Concert", "Jazz Concert"),
         what = str_replace_all(what, "Symphony Band Concert", "Symphony Concert"),
         what = str_replace_all(what, "Composition Recital", "Composition Showcase Recital"),
         what = str_replace_all(what, "Harpichord", "Harpsichord"),
         what = str_replace_all(what, "Emsemble", "Ensemble"),
         what = str_replace_all(what, "Juest Cellin'", "Just Cellin'"),
         what = str_replace_all(what, "Facutly|FACULTY|Mazariello", "Faculty")) %>% 
  mutate(event_type = case_when(
    str_detect(what, "GUEST|ODOA|Concert Series|SPCO") ~ "Guest",
    str_detect(what, "Faculty") ~ "Faculty Recital",
    str_detect(what, "Student|Senior|Junior|Piano Recital: |Johnson|Verma Jameson") ~ "Student Recital",
    str_detect(what, "Studio Recital|Organ & Harpsichord|Composition Showcase Recital|Chamber Recital|Chamber Music Recital|Chamber Music|Organ Recital|Strings Recital|Violin & Viola|Violin/Viola|Drum Ensemble|Drum Recital|Voice Showcase Recital|Chinese Music Recital|Piano Studios Recital|Jazz Chamber|Piano Recital|Comps Fest|Recorder Recital|Music Ensemble|Studio") ~ "Studio Recital",
    str_detect(what, "Orchestra Concert|Jazz Concert|Symphony Concert|Symphony Band|Choir Concert|Orchestra and Choir|Chinese & Global|Chinese Global Concert|Chinese and Global|Chinese Music Concert|Chinese Music Ensemble|Chinese Ensemble|Music Comps|Jazz Vocal Concert") ~ "Ensemble Concert",
    str_detect(what, "CSA|Just Cellin|Lunar New Year|ACA|A Cappella|Accidentals|Exit 69|Date Knight|Knights|Knightingales|International Festival") ~ "Student Activity",
    str_detect(what, "Masterclass|Lecture|Symposium") ~ "Masterclass",
    str_detect(what, "Trustees|Trustee's|Presidents|Conference|President's|Presentation") ~ "Presentation",
    str_detect(what, "Clinic|Music Fest|Music Department Showcase|Melinda Russell|Launch|Event|Opening") ~ "Special Events",
      TRUE ~ "Guest"
  )) %>% 
  mutate(year = term_to_year(term)) %>% 
  mutate(term = factor(term, levels = c("F14", "W15", "S15",
                                        "F15", "W16", "S16", "F16", "W17", "S17", 
                                        "F17", "W18", "S18", "F18", "W19", "S19", 
                                        "F19", "W20", "S20", "F20", "W21", "S21", 
                                        "F21", "W22", "S22", "F22", "W23", "S23", 
                                        "F23", "W24", "S24"), ordered = TRUE)) %>%
  arrange(year, term) %>%
  mutate(
    term_category = case_when(
      str_detect(term, "^F") ~ "Fall",
      str_detect(term, "^W") ~ "Winter",
      str_detect(term, "^S") ~ "Spring"
    )
  ) %>%
  mutate(term_category = factor(term_category, levels = c("Spring", "Winter", "Fall"), ordered = TRUE))

# Example mapping of term to start dates
term_start_dates <- data.frame(
  term = c("F14", "W15", "S15", 
           "F15", "W16", "S16", 
           "F16", "W17", "S17", 
           "F17", "W18", "S18", 
           "F18", "W19", "S19", 
           "F19", "W20", "S20", 
           "F20", "W21", "S21", 
           "F21", "W22", "S22", 
           "F22", "W23", "S23", 
           "F23", "W24", "S24"),  # Add all relevant terms
  start_date = as.Date(c("2014-09-15", "2015-01-05", "2015-03-30",
                         "2015-09-14", "2016-01-04", "2016-03-28",
                         "2016-09-12", "2017-01-04", "2017-03-27",
                         "2017-09-11", "2018-01-03", "2018-03-26",
                         "2018-09-10", "2019-01-07", "2019-04-01",
                         "2019-09-16", "2020-01-06", "2020-03-30",
                         "2020-09-14", "2021-01-04", "2021-03-29",
                         "2021-09-15", "2022-01-05", "2022-03-28",
                         "2022-09-12", "2023-01-04", "2023-03-27",
                         "2023-09-11", "2024-01-03", "2024-03-25"))  # Adjust start dates accordingly
)

# Join the start dates to the main data and calculate week_of_term
combined_data_filtered <- combined_data_filtered %>%
  left_join(term_start_dates, by = c("term" = "term")) %>%
  mutate(
    # Calculate the week of the term based on Monday as the first day of the week
    week_of_term = as.integer((floor_date(date, unit = "week", week_start = 1) - 
                               floor_date(start_date, unit = "week", week_start = 1)) / 7) + 1
  )

# Reorder columns to make week_of_term the third column
combined_data_filtered <- combined_data_filtered %>%
  select(venue, date, week_of_term, everything()) %>%
  select(-start_date)

event_summary <- combined_data_filtered %>% 
  group_by(year, term) %>% 
  summarize(term_total = n(), .groups = 'drop') %>%
  group_by(year) %>% 
  mutate(year_total = sum(term_total)) %>% 
  ungroup()
```

```{r functionalized term names}
# Install googlesheets4 if not already installed
# install.packages("googlesheets4")

# Load necessary libraries
library(googlesheets4)
library(dplyr)
library(purrr)
library(janitor)
library(stringr)
library(lubridate)

# Define the Google Sheet URL
sheet_url <- "https://docs.google.com/spreadsheets/d/1a0wHpBMmUMoeKrTK23nHcYvFpQ2djmcYKmjJqEJWX1I/edit#gid=265403245"

# Get the list of sheet names from the Google Sheet
sheet_names_list <- sheet_names(sheet_url)

# Extract the terms from the sheet names dynamically
extracted_terms <- sheet_names_list %>%
  str_extract("^[A-Z]\\d{2}") %>%
  na.omit()  # Remove any NA values in case some sheet names do not follow the pattern

# Ensure unique and sorted terms
unique_terms <- sort(unique(extracted_terms))

# Create a function to read and clean a sheet
read_and_clean_event_file <- function(sheet_name) {
  # Read the sheet using googlesheets4
  data <- read_sheet(sheet_url, sheet = sheet_name)
  
  # Clean column names and ensure all columns are character type
  clean_names(data) %>%
    mutate(across(everything(), as.character)) %>%
    mutate(term = str_sub(sheet_name, 1, 3)) # Extract the term from the sheet name
}

# Use purrr to read all sheets and store them in a named list
event_data_list <- set_names(map(sheet_names_list, read_and_clean_event_file), sheet_names_list)

# Combine all the data frames into one
combined_data <- reduce(event_data_list, full_join)

# Define the term start dates (hardcoded as per the original logic)
term_start_dates <- data.frame(
  term = c("F14", "W15", "S15", 
           "F15", "W16", "S16", 
           "F16", "W17", "S17", 
           "F17", "W18", "S18", 
           "F18", "W19", "S19", 
           "F19", "W20", "S20", 
           "F20", "W21", "S21", 
           "F21", "W22", "S22", 
           "F22", "W23", "S23", 
           "F23", "W24", "S24"),  # Add all relevant terms
  start_date = as.Date(c("2014-09-15", "2015-01-05", "2015-03-30",
                         "2015-09-14", "2016-01-04", "2016-03-28",
                         "2016-09-12", "2017-01-04", "2017-03-27",
                         "2017-09-11", "2018-01-03", "2018-03-26",
                         "2018-09-10", "2019-01-07", "2019-04-01",
                         "2019-09-16", "2020-01-06", "2020-03-30",
                         "2020-09-14", "2021-01-04", "2021-03-29",
                         "2021-09-15", "2022-01-05", "2022-03-28",
                         "2022-09-12", "2023-01-04", "2023-03-27",
                         "2023-09-11", "2024-01-03", "2024-03-25"))  # Adjust start dates accordingly
)

# Function to calculate the week of term
calculate_week_of_term <- function(event_date, term) {
  start_date <- term_start_dates %>%
    filter(term == !!term) %>%
    pull(start_date)
  
  if(length(start_date) == 0) return(NA_integer_)  # Return NA if no start_date is found
  
  # Calculate the week of the term based on Monday as the first day of the week
  week_of_term <- as.integer((floor_date(event_date, unit = "week", week_start = 1) - 
                              floor_date(start_date, unit = "week", week_start = 1)) / 7) + 1
  return(week_of_term)
}

# Apply the new function to calculate week_of_term dynamically
combined_data_filtered <- combined_data %>%
  filter(!is.na(what), what != "") %>%
  filter(what != "Choir & Jazz Rehearsal") %>%
  filter(what != "Jazz Rehearsal") %>%
  mutate(date = as.Date(ymd(date))) %>%
  mutate(support_level = if_else(support_level == "N" | support_level == "Y", "L", support_level)) %>%
  mutate(
    department = str_replace_all(department, "WCC", "ODOA"),
    department = str_replace_all(department, "MSUC", "MUSC"),
    department = str_replace_all(department, "French Dept|French", "FREN"),
    department = str_replace_all(department, "English", "ENGL"),
    department = str_replace_all(department, "Pres. Office", "PRES"),
    department = str_replace_all(department, "History", "HIST"),
    department = str_replace_all(department, "THD", "THDA"),
    department = str_replace_all(department, "Inclusion & Equity", "IEC"),
    venue = str_replace_all(venue, "Skinner Chapel", "Chapel"),
    department = str_replace_all(department, "/", " & "),
    department = str_replace_all(department, ",", " &"),
    venue = str_replace_all(venue, ",", " &"),
    department = str_replace_all(department, "\\s+", " ")  # Remove extra spaces
  ) %>%
  select(-wk) %>%
  mutate(department_type = case_when(
    department == "MUSC" ~ "MUSC",
    department == "ODOA" ~ "ODOA",
    department == "CSA" ~ "CSA",
    str_detect(department, "&") ~ "Collab",
    TRUE ~ "Others"
  )) %>%
  mutate(what = str_replace_all(what, "Jazz Ensemble Concert|Jazz Area Concert", "Jazz Concert"),
         what = str_replace_all(what, "Symphony Band Concert", "Symphony Concert"),
         what = str_replace_all(what, "Composition Recital", "Composition Showcase Recital"),
         what = str_replace_all(what, "Harpichord", "Harpsichord"),
         what = str_replace_all(what, "Emsemble", "Ensemble"),
         what = str_replace_all(what, "Juest Cellin'", "Just Cellin'"),
         what = str_replace_all(what, "Facutly|FACULTY|Mazariello", "Faculty")) %>%
  mutate(event_type = case_when(
    str_detect(what, "GUEST|ODOA|Concert Series|SPCO") ~ "Guest",
    str_detect(what, "Faculty") ~ "Faculty Recital",
    str_detect(what, "Student|Senior|Junior|Piano Recital: |Johnson|Verma Jameson") ~ "Student Recital",
    str_detect(what, "Studio Recital|Organ & Harpsichord|Composition Showcase Recital|Chamber Recital|Chamber Music Recital|Chamber Music|Organ Recital|Strings Recital|Violin & Viola|Violin/Viola|Drum Ensemble|Drum Recital|Voice Showcase Recital|Chinese Music Recital|Piano Studios Recital|Jazz Chamber|Piano Recital|Comps Fest|Recorder Recital|Music Ensemble|Studio") ~ "Studio Recital",
    str_detect(what, "Orchestra Concert|Jazz Concert|Symphony Concert|Symphony Band|Choir Concert|Orchestra and Choir|Chinese & Global|Chinese Global Concert|Chinese and Global|Chinese Music Concert|Chinese Music Ensemble|Chinese Ensemble|Music Comps|Jazz Vocal Concert") ~ "Ensemble Concert",
    str_detect(what, "CSA|Just Cellin|Lunar New Year|ACA|A Cappella|Accidentals|Exit 69|Date Knight|Knights|Knightingales|International Festival") ~ "Student Activity",
    str_detect(what, "Masterclass|Lecture|Symposium") ~ "Masterclass",
    str_detect(what, "Trustees|Trustee's|Presidents|Conference|President's|Presentation") ~ "Presentation",
    str_detect(what, "Clinic|Music Fest|Music Department Showcase|Melinda Russell|Launch|Event|Opening") ~ "Special Events",
    TRUE ~ "Guest"
  )) %>%
  mutate(year = term_to_year(term)) %>%
  mutate(term = factor(term, levels = unique_terms, ordered = TRUE)) %>%
  arrange(year, term) %>%
  mutate(
    term_category = case_when(
      str_detect(term, "^F") ~ "Fall",
      str_detect(term, "^W") ~ "Winter",
      str_detect(term, "^S") ~ "Spring"
    )
  ) %>%
  mutate(term_category = factor(term_category, levels = c("Spring", "Winter", "Fall"), ordered = TRUE)) %>%
  # Apply week_of_term calculation
  rowwise() %>%
  mutate(week_of_term = calculate_week_of_term(date, term)) %>%
  ungroup()

# Example event summary after filtering and transformation
event_summary <- combined_data_filtered %>%
  group_by(year, term) %>%
  summarize(term_total = n(), .groups = 'drop') %>%
  group_by(year) %>%
  mutate(year_total = sum(term_total)) %>%
  ungroup()

# View event_summary for validation
print(event_summary)

```

```{r plot 1}
library(googlesheets4)
library(dplyr)
library(stringr)
library(ggplot2)
library(plotly)

# Function to get sheet names from Google Sheets
get_sheet_names <- function(sheet_url) {
  sheet_names <- sheets_sheets(sheet_url)
  return(sheet_names)
}

# Function to extract term from sheet name
extract_term <- function(sheet_name) {
  # Extract term from sheet name assuming format "F14 - Event Data", "W15 - Event Data", etc.
  term_match <- str_extract(sheet_name, "^[FWS]\\d{2}")
  return(term_match)
}

# Function to process and sort event summary based on dynamic term levels
process_event_summary <- function(event_summary, sheet_names) {
  # Extract terms from sheet names
  terms <- unique(sapply(sheet_names, extract_term))
  
  # Define term levels based on sheet names
  term_levels <- c()
  for (season in c("F", "W", "S")) {
    term_levels <- c(term_levels, sort(terms[str_detect(terms, paste0("^", season))]))
  }
  
  event_summary %>%
    mutate(term = factor(term, levels = term_levels, ordered = TRUE)) %>%
    arrange(year, term) %>%
    mutate(
      term_category = case_when(
        str_detect(term, "^F") ~ "Fall",
        str_detect(term, "^W") ~ "Winter",
        str_detect(term, "^S") ~ "Spring"
      )
    ) %>%
    mutate(term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE))
}

# URL of the Google Sheets
sheet_url <- "https://docs.google.com/spreadsheets/d/1a0wHpBMmUMoeKrTK23nHcYvFpQ2djmcYKmjJqEJWX1I/edit?gid=265403245"

# Fetch sheet names
sheet_names <- sheet_names(sheet_url)

# Assuming event_summary is already loaded
# Process the event summary data frame
event_summary_processed <- process_event_summary(event_summary, sheet_names)

# Create the stacked bar chart using ggplot2
ggplot_event_summary <- ggplot(event_summary_processed, aes(x = year, y = term_total, fill = term_category)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = term_total), 
            position = position_stack(vjust = 0.5), 
            size = 3, 
            color = "black") +
  scale_fill_manual(values = c("Fall" = "#FF9999", "Winter" = "#99CCFF", "Spring" = "#99FF99")) +
  labs(x = "Year", y = "Total Events", fill = "Term") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert the ggplot object to a plotly object for interactivity
plotly_event_summary <- ggplotly(ggplot_event_summary)

# Display the plotly chart
plotly_event_summary

```



```{r plot 2}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)

# Function to summarize and pivot data for each year
summarize_and_pivot <- function(current_year) {
  combined_data_filtered %>%
    filter(year == current_year) %>%
    group_by(term_category, support_level) %>%
    summarize(Support = n(), .groups = 'drop') %>%
    pivot_wider(names_from = support_level, values_from = Support, values_fill = list(Support = 0)) %>%
    mutate(year = current_year)  # Add a year column to identify the table
}

# List of years to iterate over
years <- unique(combined_data_filtered$year)

# Use purrr::map to apply summarize_and_pivot function for each year
support_tables <- map_dfr(years, summarize_and_pivot)  # Combine into a single data frame

# Melt the data for ggplot
support_tables_melted <- support_tables %>%
  pivot_longer(cols = -c(term_category, year), names_to = "support_level", values_to = "Support")

# Ensure the term_category and support_level are factors with the correct order
support_tables_melted <- support_tables_melted %>%
  filter(support_level != "NA") %>% 
  mutate(term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE),
         support_level = factor(support_level, levels = c("NA", "H", "M", "L"), ordered = TRUE))

# Calculate percentages for each segment
support_tables_melted <- support_tables_melted %>%
  group_by(year, term_category) %>%
  mutate(total_support = sum(Support),
         percentage = (Support / total_support) * 100)

# Create the ggplot chart
ggplot_support_summary <- ggplot(support_tables_melted, aes(x = term_category, y = Support, fill = support_level)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(Support, " (", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5), size = 2, color = "black") +
  facet_wrap(~ year) +
  labs(x = "Term", y = "Support Count", fill = "Support Level") +
  scale_fill_manual(values = c("H" = "#FF9999", "M" = "#99CCFF", "L" = "#99FF99", "NA" = "black")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to a plotly object
plotly_support_summary <- ggplotly(ggplot_support_summary)

# Display the plotly chart
plotly_support_summary

```

```{r plot 3}

library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)

# Function to summarize and pivot data for each year
summarize_and_pivot_department <- function(current_year) {
  combined_data_filtered %>%
    filter(year == current_year) %>%
    group_by(term_category, department_type) %>%
    summarize(DepartmentCount = n(), .groups = 'drop') %>%
    pivot_wider(names_from = department_type, values_from = DepartmentCount, values_fill = list(DepartmentCount = 0)) %>%
    mutate(year = current_year)  # Add a year column to identify the table
}

# List of years to iterate over
years <- unique(combined_data_filtered$year)

# Use purrr::map to apply summarize_and_pivot function for each year
department_tables <- map_dfr(years, summarize_and_pivot_department)  # Combine into a single data frame

# Melt the data for ggplot
department_tables_melted <- department_tables %>%
  pivot_longer(cols = -c(term_category, year), names_to = "department_type", values_to = "DepartmentCount")

# Ensure the term_category and department_type are factors with the correct order
department_tables_melted <- department_tables_melted %>%
  mutate(term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE),
         department_type = factor(department_type, levels = c("MUSC", "ODOA", "CSA", "Collab", "Others"), ordered = TRUE))

# Filter out NA department types (if any)
department_tables_melted <- department_tables_melted %>%
  filter(department_type != "NA")

# Calculate percentages for each segment
department_tables_melted <- department_tables_melted %>%
  group_by(year, term_category) %>%
  mutate(total_count = sum(DepartmentCount, na.rm = TRUE),
         percentage = (DepartmentCount / total_count) * 100)

# Create the ggplot chart
ggplot_department_summary <- ggplot(department_tables_melted, aes(x = term_category, y = DepartmentCount, fill = department_type)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(DepartmentCount, " (", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5), size = 2, color = "black",
            check_overlap = TRUE) +
  facet_wrap(~ year) +
  labs(x = "Term", y = "Department Count", fill = "Department Type") +
  scale_fill_manual(values = c("MUSC" = "#FF9999", "ODOA" = "#99CCFF", "CSA" = "#99FF99", "Collab" = "#FFD700", "Others" = "#FFA500")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to a plotly object
plotly_department_summary <- ggplotly(ggplot_department_summary)

# Display the plotly chart
plotly_department_summary


```


```{r plot 4}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)

# Function to summarize and pivot data for each year
summarize_and_pivot_event <- function(current_year) {
  combined_data_filtered %>%
    filter(year == current_year) %>%
    group_by(term_category, event_type) %>%
    summarize(EventCount = n(), .groups = 'drop') %>%
    pivot_wider(names_from = event_type, values_from = EventCount, values_fill = list(EventCount = 0)) %>%
    mutate(year = current_year)  # Add a year column to identify the table
}

# List of years to iterate over
years <- unique(combined_data_filtered$year)

# Use purrr::map to apply summarize_and_pivot function for each year
event_tables <- map_dfr(years, summarize_and_pivot_event)  # Combine into a single data frame

# Melt the data for ggplot
event_tables_melted <- event_tables %>%
  pivot_longer(cols = -c(term_category, year), names_to = "event_type", values_to = "EventCount")

# Ensure term_category and event_type are characters before converting to factors
event_tables_melted <- event_tables_melted %>%
  mutate(
    term_category = as.character(term_category),
    event_type = as.character(event_type)
  )

# Apply the factor conversion with ordering
event_tables_melted <- event_tables_melted %>%
  mutate(
    term_category = factor(term_category, levels = c("Fall", "Winter", "Spring"), ordered = TRUE),
    event_type = factor(event_type, levels = c("Ensemble Concert", "Student Activity", "Studio Recital",
                                               "Guest", "Faculty Recital", "Student Recital",
                                               "Special Events", "Presentation", "Masterclass"),
                        ordered = TRUE)
  )

# Calculate percentages for each segment
event_tables_melted <- event_tables_melted %>%
  group_by(year, term_category) %>%
  mutate(total_count = sum(EventCount, na.rm = TRUE),
         percentage = (EventCount / total_count) * 100)

# Create the ggplot chart
ggplot_event_summary <- ggplot(event_tables_melted, aes(x = term_category, y = EventCount, fill = event_type)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = paste0(EventCount, " (", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5), size = 2, color = "black",
            check_overlap = TRUE) +
  facet_wrap(~ year) +
  labs(x = "Term", y = "Event Count", fill = "Event Type") +
  scale_fill_brewer(palette = "Set2") +  # Using a Brewer palette for default colors
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to a plotly object
plotly_event_summary <- ggplotly(ggplot_event_summary)

# Display the plotly chart
plotly_event_summary

```


```{r}
library(shiny)
library(shinyauthr)

# dataframe that holds usernames, passwords and other user data
user_base <- tibble::tibble(
  user = c("user1", "user2"),
  password = sapply(c("pass1", "pass2"), sodium::password_store),
  permissions = c("admin", "standard"),
  name = c("User One", "User Two")
)

ui <- fluidPage(
  # logout button
  div(class = "pull-right", shinyauthr::logoutUI(id = "logout")),
  
  # login section
  shinyauthr::loginUI(id = "login"),
  
  # Sidebar to show user info after login
  uiOutput("sidebarpanel"),
  
  # Plot to show user info after login
  plotOutput("distPlot")
  
)

server <- function(input, output, session) {
  
  credentials <- shinyauthr::loginServer(
    id = "login",
    data = user_base,
    user_col = user,
    pwd_col = password,
    sodium_hashed = TRUE,
    log_out = reactive(logout_init())
  )
  
  # Logout to hide
  logout_init <- shinyauthr::logoutServer(
    id = "logout",
    active = reactive(credentials()$user_auth)
  )
  
  
  output$sidebarpanel <- renderUI({
    
    # Show only when authenticated
    req(credentials()$user_auth)
    
    tagList(
    # Sidebar with a slider input
    column(width = 4,
      sliderInput("obs",
                  "Number of observations:",
                  min = 0,
                  max = 1000,
                  value = 500)
    ),
    
    column(width = 4,
           p(paste("You have", credentials()$info[["permissions"]],"permission"))
           )
    )
    
  })
  
    # Plot
    output$distPlot <- renderPlot({
      
      # Show plot only when authenticated
      req(credentials()$user_auth)
      
      if(!is.null(input$obs)) {
        hist(rnorm(input$obs)) 
      }
      
    })
    
    
}

shinyApp(ui = ui, server = server)
```


```{r}
library(shiny)
library(shinydashboard)
library(DT)
library(shinyjs)
library(sodium)

# Main login screen
loginpage <- div(id = "loginpage", style = "width: 500px; max-width: 100%; margin: 0 auto; padding: 20px;",
                 wellPanel(
                   tags$h2("LOG IN", class = "text-center", style = "padding-top: 0;color:#333; font-weight:600;"),
                   textInput("userName", placeholder="Username", label = tagList(icon("user"), "Username")),
                   passwordInput("passwd", placeholder="Password", label = tagList(icon("unlock-alt"), "Password")),
                   br(),
                   div(
                     style = "text-align: center;",
                     actionButton("login", "SIGN IN", style = "color: white; background-color:#3c8dbc;
                                 padding: 10px 15px; width: 150px; cursor: pointer;
                                 font-size: 18px; font-weight: 600;"),
                     shinyjs::hidden(
                       div(id = "nomatch",
                           tags$p("Oops! Incorrect username or password!",
                                  style = "color: red; font-weight: 600; 
                                            padding-top: 5px;font-size:16px;", 
                                  class = "text-center"))),
                     br(),
                     br(),
                     tags$code("Username: myuser  Password: mypass"),
                     br(),
                     tags$code("Username: myuser1  Password: mypass1")
                   ))
)

credentials <- data.frame(
  username_id = c("myuser", "myuser1"),
  password   = sapply(c("mypass", "mypass1"), password_store),
  permission  = c("basic", "advanced"), 
  stringsAsFactors = FALSE
)

header <- dashboardHeader(title = "Simple Dashboard", uiOutput("logoutbtn"))

sidebar <- dashboardSidebar(uiOutput("sidebarpanel")) 
body <- dashboardBody(shinyjs::useShinyjs(), uiOutput("body"))
ui <- dashboardPage(header, sidebar, body, skin = "blue")

server <- function(input, output, session) {
  
  USER <- reactiveValues(login = FALSE)
  
  observe({ 
    if (USER$login == FALSE) {
      if (!is.null(input$login)) {
        if (input$login > 0) {
          Username <- isolate(input$userName)
          Password <- isolate(input$passwd)
          if (length(which(credentials$username_id == Username)) == 1) { 
            pasmatch <- credentials$password[which(credentials$username_id == Username)]
            pasverify <- password_verify(pasmatch, Password)
            if (pasverify) {
              USER$login <- TRUE
            } else {
              shinyjs::toggle(id = "nomatch", anim = TRUE, time = 1, animType = "fade")
              shinyjs::delay(3000, shinyjs::toggle(id = "nomatch", anim = TRUE, time = 1, animType = "fade"))
            }
          } else {
            shinyjs::toggle(id = "nomatch", anim = TRUE, time = 1, animType = "fade")
            shinyjs::delay(3000, shinyjs::toggle(id = "nomatch", anim = TRUE, time = 1, animType = "fade"))
          }
        } 
      }
    }    
  })
  
  output$logoutbtn <- renderUI({
    req(USER$login)
    tags$li(a(icon("sign-out"), "Logout", 
              href="javascript:window.location.reload(true)"),
            class = "dropdown", 
            style = "background-color: #eee !important; border: 0;
                    font-weight: bold; margin:5px; padding: 10px;")
  })
  
  output$sidebarpanel <- renderUI({
    if (USER$login == TRUE ){ 
      if (credentials[,"permission"][which(credentials$username_id==input$userName)]=="advanced") {
        sidebarMenu(
        menuItem("Main Page", tabName = "dashboard", icon = icon("dashboard")),
        menuItem("About Page", tabName = "About", icon = icon("th"))
        )
      }
      else{
        sidebarMenu(
          menuItem("Main Page", tabName = "dashboard", icon = icon("dashboard"))
        )
        
      }
    }
  })
  
  
  output$body <- renderUI({
    if (USER$login == TRUE ) {
    if (credentials[,"permission"][which(credentials$username_id==input$userName)]=="advanced") {
    tabItems(
              tabItem(
               tabName ="dashboard", class = "active",
               fluidRow(
                box(width = 12, dataTableOutput('results'))
              ))
        ,
          tabItem(
            tabName ="About",
            h2("This is second tab")
              )
    )
    } 
      else {
        tabItem(
          tabName ="dashboard", class = "active",
          fluidRow(
            box(width = 12, dataTableOutput('results'))
          ))
        
      }
    
    }
    else {
      loginpage
    }
  })
  
  output$results <- DT::renderDataTable({
    datatable(iris, options = list(autoWidth = TRUE, searching = FALSE))
  })
  
  output$results2 <- DT::renderDataTable({
    datatable(mtcars, options = list(autoWidth = TRUE, searching = FALSE))
  })
}

shinyApp(ui = ui, server = server)

```

```{r}
combined_data_filtered <- combined_data %>%
  filter(!is.na(what), what != "") %>%
  filter(what != "Choir & Jazz Rehearsal") %>%
  filter(what != "Jazz Rehearsal") %>%
  mutate(date = as.Date(ymd(date))) %>%
  mutate(
    livestream = coalesce(livestream, live_stream)  # If 'livestream' is NA, use 'live_stream'
  ) %>%
  select(-live_stream) %>%  
  mutate(
    support_level = fct_relevel(factor(support_level), "H", "M", "L"),
    audio_needs = fct_relevel(factor(audio_needs), "H", "M", "L"),
    stage_needs = fct_relevel(factor(stage_needs), "H", "M", "L"),
    lighting_needs = fct_relevel(factor(lighting_needs), "H", "M", "L"),
    projection = fct_relevel(factor(projection), "Y", "N"),
    video_recording = fct_relevel(factor(video_recording), "Y", "N"),
    livestream = fct_relevel(factor(livestream), "Y", "N"),
    poster = fct_relevel(factor(poster), "Y", "N"),
    program = fct_relevel(factor(program), "Y", "N"),
    reception = fct_relevel(factor(reception), "Y", "N")
  ) %>%
  mutate(
    venue = factor(venue),
    department = factor(department)
  ) %>%  
  mutate(
    audience_count = as.numeric(ifelse(grepl("^[0-9]+$", audience_count), audience_count, NA)),
    days_committed = as.numeric(ifelse(grepl("^[0-9]+$", days_committed), days_committed, NA)),
    av_staff = as.numeric(ifelse(grepl("^[0-9]+$", av_staff), av_staff, NA)),
    pac_staff = as.numeric(ifelse(grepl("^[0-9]+$", pac_staff), pac_staff, NA))
  ) %>%  
  mutate(support_level = if_else(support_level == "N" | support_level == "Y", "L", support_level)) %>%
  mutate(
    department = str_replace_all(department, "WCC", "ODOA"),
    department = str_replace_all(department, "MSUC", "MUSC"),
    department = str_replace_all(department, "French Dept|French", "FREN"),
    department = str_replace_all(department, "English", "ENGL"),
    department = str_replace_all(department, "Pres. Office", "PRES"),
    department = str_replace_all(department, "History", "HIST"),
    department = str_replace_all(department, "THD", "THDA"),
    department = str_replace_all(department, "Inclusion & Equity", "IEC"),
    venue = str_replace_all(venue, "Skinner Chapel", "Chapel"),
    department = str_replace_all(department, "/", " & "),
    department = str_replace_all(department, ",", " &"),
    venue = str_replace_all(venue, ",", " &"),
    department = str_replace_all(department, "\\s+", " ")  # Remove extra spaces
  ) %>%
  select(-wk) %>%
  mutate(department_type = case_when(
    department == "MUSC" ~ "MUSC",
    department == "ODOA" ~ "ODOA",
    department == "CSA" ~ "CSA",
    str_detect(department, "&") ~ "Collab",
    TRUE ~ "Others"
  )) %>%
  mutate(what = str_replace_all(what, "Jazz Ensemble Concert|Jazz Area Concert", "Jazz Concert"),
         what = str_replace_all(what, "Symphony Band Concert", "Symphony Concert"),
         what = str_replace_all(what, "Composition Recital", "Composition Showcase Recital"),
         what = str_replace_all(what, "Harpichord", "Harpsichord"),
         what = str_replace_all(what, "Emsemble", "Ensemble"),
         what = str_replace_all(what, "Juest Cellin'", "Just Cellin'"),
         what = str_replace_all(what, "Facutly|FACULTY|Mazariello", "Faculty")) %>%
  mutate(event_type = case_when(
    str_detect(what, "GUEST|ODOA|Concert Series|SPCO") ~ "Guest",
    str_detect(what, "Faculty") ~ "Faculty Recital",
    str_detect(what, "Student|Senior|Junior|Piano Recital: |Johnson|Verma Jameson") ~ "Student Recital",
    str_detect(what, "Studio Recital|Organ & Harpsichord|Composition Showcase Recital|Chamber Recital|Chamber Music Recital|Chamber Music|Organ Recital|Strings Recital|Violin & Viola|Violin/Viola|Drum Ensemble|Drum Recital|Voice Showcase Recital|Chinese Music Recital|Piano Studios Recital|Jazz Chamber|Piano Recital|Comps Fest|Recorder Recital|Music Ensemble|Studio") ~ "Studio Recital",
    str_detect(what, "Orchestra Concert|Jazz Concert|Symphony Concert|Symphony Band|Choir Concert|Orchestra and Choir|Chinese & Global|Chinese Global Concert|Chinese and Global|Chinese Music Concert|Chinese Music Ensemble|Chinese Ensemble|Music Comps|Jazz Vocal Concert") ~ "Ensemble Concert",
    str_detect(what, "CSA|Just Cellin|Lunar New Year|ACA|A Cappella|Accidentals|Exit 69|Date Knight|Knights|Knightingales|International Festival") ~ "Student Activity",
    str_detect(what, "Masterclass|Lecture|Symposium") ~ "Masterclass",
    str_detect(what, "Trustees|Trustee's|Presidents|Conference|President's|Presentation") ~ "Presentation",
    str_detect(what, "Clinic|Music Fest|Music Department Showcase|Melinda Russell|Launch|Event|Opening") ~ "Special Events",
    TRUE ~ "Guest"
  )) %>%
  mutate(year = term_to_year(term)) %>%
  mutate(term = factor(term, levels = unique_terms, ordered = TRUE)) %>%
  arrange(year, term) %>%
  mutate(
    term_category = case_when(
      str_detect(term, "^F") ~ "Fall",
      str_detect(term, "^W") ~ "Winter",
      str_detect(term, "^S") ~ "Spring"
    )
  ) %>%
  mutate(term_category = factor(term_category, levels = c("Spring", "Winter", "Fall"), ordered = TRUE)) %>%
  # Apply week_of_term calculation
  rowwise() %>%
  mutate(week_of_term = calculate_week_of_term(date, term)) %>%
  ungroup()

combined_data_filtered %>%
    reactable(
      theme = clean(),  # Apply the clean theme for a minimalist design
      pagination = TRUE,  # Enable pagination
      columns = list(
        venue = colDef(name = "Venue"),
        date = colDef(name = "Date"),
        what = colDef(name = "Event"),
        department = colDef(name = "Department"),
        days_committed = colDef(
          name = "Days Committed",
          cell = data_bars(
            data = .,
            fill_color = viridis::plasma(4),
            background = '#F1F1F1',
            text_position = 'outside-end',
            number_fmt = scales::comma
          )
        ),
        av_staff = colDef(
          name = "AV Staff",
          cell = data_bars(
            data = .,
            fill_color = viridis::inferno(9),
            fill_opacity = 0.8,
            round_edges = TRUE,
            text_position = 'outside-end',
            number_fmt = scales::comma
          )
        ),
        pac_staff = colDef(
          name = "PAC Staff",
          cell = data_bars(
            data = .,
            fill_color = viridis::inferno(9),
            fill_opacity = 0.8,
            round_edges = TRUE,
            text_position = 'outside-end',
            number_fmt = scales::comma
          )
        ),
        support_level = colDef(
          name = "Support Level",
          cell = function(value) {
            color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        audio_needs = colDef(
          name = "Audio Needs",
          cell = function(value) {
            color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        stage_needs = colDef(
          name = "Stage Needs",
          cell = function(value) {
            color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        lighting_needs = colDef(
          name = "Lighting Needs",
          cell = function(value) {
            color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        projection = colDef(
          name = "Projection",
          cell = function(value) {
            color_map <- c("Y" = "green", "N" = "red")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        video_recording = colDef(
          name = "Video Recording",
          cell = function(value) {
            color_map <- c("Y" = "green", "N" = "red")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        livestream = colDef(
          name = "Livestream",
          cell = function(value) {
            color_map <- c("Y" = "green", "N" = "red")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        audience_count = colDef(
          name = "Audience Count",
          cell = data_bars(
            data = .,
            fill_color = viridis::turbo(5),
            background = 'darkgrey',
            border_style = 'solid',
            border_width = '1px',
            border_color = 'forestgreen',
            box_shadow = TRUE,
            text_position = 'inside-base',
            number_fmt = scales::comma
          )
        ),
        poster = colDef(
          name = "Poster",
          cell = function(value) {
            color_map <- c("Y" = "green", "N" = "red")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        program = colDef(
          name = "Program",
          cell = function(value) {
            color_map <- c("Y" = "green", "N" = "red")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        reception = colDef(
          name = "Reception",
          cell = function(value) {
            color_map <- c("Y" = "green", "N" = "red")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        term = colDef(name = "Term"),
        department_type = colDef(
          name = "Department Type",
          cell = function(value) {
            color_map <- c("MUSC" = "blue", "ODOA" = "purple", "CSA" = "orange", "Collab" = "maroon", "Others" = "pink")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        event_type = colDef(
          name = "Event Type",
          cell = function(value) {
            color_map <- c("Guest" = "blue", "Faculty Recital" = "purple", "Student Recital" = "orange", "Studio Recital" = "grey", "Ensemble Concert" = "lightgrey", "Student Activity" = "pink", "Masterclass" = "cyan", "Presentation" = "lightblue", "Special Events" = "lightgreen")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        year = colDef(name = "Year"),
        term_category = colDef(name = "Term Category"),
        week_of_term = colDef(name = "Week of Term")
      )
    )

```


```{r}
library(reactable)
library(viridis)

# Generate color maps for venue and department columns
venue_colors <- viridis(n = length(unique(combined_data_filtered$venue)), option = "viridis")
department_colors <- viridis(n = length(unique(combined_data_filtered$department)), option = "viridis")

venue_map <- setNames(venue_colors, unique(combined_data_filtered$venue))
department_map <- setNames(department_colors, unique(combined_data_filtered$department))

combined_data_filtered %>% 
  reactable(
    theme = clean(),  # Apply the clean theme for a minimalist design
    pagination = TRUE,  # Enable pagination
    columns = list(
      venue = colDef(
        name = "Venue",
        cell = function(value) {
          color <- venue_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      date = colDef(name = "Date"),
      what = colDef(name = "Event"),
      department = colDef(
        name = "Department",
        cell = function(value) {
          color <- department_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      days_committed = colDef(
        name = "Days Committed",
        cell = data_bars(
          data = .,
          fill_color = viridis::plasma(4),
          background = '#F1F1F1',
          text_position = 'outside-end',
          number_fmt = scales::comma
        )
      ),
      av_staff = colDef(
        name = "AV Staff",
        cell = data_bars(
          data = .,
          fill_color = viridis::inferno(9),
          fill_opacity = 0.8,
          round_edges = TRUE,
          text_position = 'outside-end',
          number_fmt = scales::comma
        )
      ),
      pac_staff = colDef(
        name = "PAC Staff",
        cell = data_bars(
          data = .,
          fill_color = viridis::inferno(9),
          fill_opacity = 0.8,
          round_edges = TRUE,
          text_position = 'outside-end',
          number_fmt = scales::comma
        )
      ),
      support_level = colDef(
        name = "Support Level",
        cell = function(value) {
          color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      audio_needs = colDef(
        name = "Audio Needs",
        cell = function(value) {
          color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      stage_needs = colDef(
        name = "Stage Needs",
        cell = function(value) {
          color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      lighting_needs = colDef(
        name = "Lighting Needs",
        cell = function(value) {
          color_map <- c("H" = "lightcoral", "M" = "lightblue", "L" = "lightgreen")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      projection = colDef(
        name = "Projection",
        cell = function(value) {
          color_map <- c("Y" = "green", "N" = "red")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      video_recording = colDef(
        name = "Video Recording",
        cell = function(value) {
          color_map <- c("Y" = "green", "N" = "red")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      livestream = colDef(
        name = "Livestream",
        cell = function(value) {
          color_map <- c("Y" = "green", "N" = "red")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      audience_count = colDef(
        name = "Audience Count",
        cell = data_bars(
          data = .,
          fill_color = viridis::turbo(5),
          background = 'darkgrey',
          border_style = 'solid',
          border_width = '1px',
          border_color = 'forestgreen',
          box_shadow = TRUE,
          text_position = 'inside-base',
          number_fmt = scales::comma
        )
      ),
      poster = colDef(
        name = "Poster",
        cell = function(value) {
          color_map <- c("Y" = "green", "N" = "red")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      program = colDef(
        name = "Program",
        cell = function(value) {
          color_map <- c("Y" = "green", "N" = "red")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      reception = colDef(
        name = "Reception",
        cell = function(value) {
          color_map <- c("Y" = "green", "N" = "red")
          color <- color_map[as.character(value)]
          if (is.na(color)) color <- "lightgrey"
          tags$span(
            style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
            as.character(value)
          )
        }
      ),
      term = colDef(name = "Term"),
      department_type = colDef(
          name = "Department Type",
          cell = function(value) {
            color_map <- c("MUSC" = "blue", "ODOA" = "purple", "CSA" = "orange", "Collab" = "maroon", "Others" = "pink")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        event_type = colDef(
          name = "Event Type",
          cell = function(value) {
            color_map <- c("Guest" = "blue", "Faculty Recital" = "purple", "Student Recital" = "orange", "Studio Recital" = "grey", "Ensemble Concert" = "lightgrey", "Student Activity" = "pink", "Masterclass" = "cyan", "Presentation" = "lightblue", "Special Events" = "lightgreen")
            color <- color_map[as.character(value)]
            if (is.na(color)) color <- "lightgrey"
            tags$span(
              style = paste0("background-color: ", color, "; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;"),
              as.character(value)
            )
          }
        ),
        year = colDef(name = "Year"),
        term_category = colDef(name = "Term Category"),
        week_of_term = colDef(name = "Week of Term")
    )
  )
```

